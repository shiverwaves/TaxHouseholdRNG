name: Enhanced Family Generator

on:
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of families to generate'
        required: false
        default: '10'
        type: string
      state:
        description: 'Target state (e.g., California, Texas)'
        required: false
        default: ''
        type: string

  push:
    branches: [ main ]

jobs:
  generate-families:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psycopg2-binary python-dotenv
    
    - name: Build command arguments
      id: build_args
      run: |
        ARGS="--count ${{ github.event.inputs.count || '10' }}"
        
        if [[ -n "${{ github.event.inputs.state }}" ]]; then
          ARGS="$ARGS --state '${{ github.event.inputs.state }}'"
        fi
        
        echo "args=$ARGS" >> $GITHUB_OUTPUT
        echo "Generated command: python enhanced_family_generator.py $ARGS"
    
    - name: Generate Families
      env:
        NEON_CONNECTION_STRING: ${{ secrets.NEON_CONNECTION_STRING }}
      run: |
        echo "ğŸ  Generating families with enhanced database integration..."
        echo "Command: python enhanced_family_generator.py ${{ steps.build_args.outputs.args }}"
        echo ""
        
        python enhanced_family_generator.py ${{ steps.build_args.outputs.args }} 2>&1 | tee generation_output.txt
    
    - name: Create Generation Metadata
      run: |
        echo "ğŸ“Š Creating generation metadata..."
        
        COUNT="${{ github.event.inputs.count || '10' }}"
        STATE="${{ github.event.inputs.state || 'random' }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        cat > generation_metadata.json << EOF
        {
          "generation_date": "$TIMESTAMP",
          "generator_version": "enhanced_v1",
          "database_integration": true,
          "parameters": {
            "count": "$COUNT",
            "state": "$STATE"
          },
          "data_sources": [
            "OEWS wage data",
            "Census state demographics", 
            "Education-occupation probability matrices",
            "State employment statistics"
          ],
          "features": [
            "Real employment rates by state and education",
            "Probability-based occupation selection", 
            "Current wages from OEWS database",
            "Realistic unemployment benefits",
            "State-specific education distributions"
          ],
          "output_files": [
            "generation_output.txt",
            "generation_metadata.json"
          ]
        }
        EOF
        
        echo "âœ… Generation metadata created"
    
    - name: Generate Summary Report
      run: |
        echo ""
        echo "ğŸ“Š ENHANCED FAMILY GENERATOR SUMMARY"
        echo "============================================================"
        echo "ğŸ“… Generated: $(date -u)"
        echo "ğŸ”— Generator Version: enhanced_v1"
        echo "ğŸ‘¥ Count Requested: ${{ github.event.inputs.count || '10' }}"
        echo "ğŸ¯ Target State: ${{ github.event.inputs.state || 'random' }}"
        echo ""
        echo "ğŸš€ ENHANCED FEATURES:"
        echo "   âœ… Real employment rates by state and education"
        echo "   âœ… Probability-based occupation selection"
        echo "   âœ… Current wages from OEWS database"
        echo "   âœ… Realistic unemployment benefits"
        echo "   âœ… State-specific education distributions"
        echo ""
        echo "ğŸ“Š DATA SOURCES:"
        echo "   â€¢ OEWS wage data"
        echo "   â€¢ Census state demographics"
        echo "   â€¢ Education-occupation probability matrices"
        echo "   â€¢ State employment statistics"
        echo ""
        echo "ğŸ’¡ FULL FAMILY DETAILS:"
        echo "   The complete family data with all member details"
        echo "   was displayed in the 'Generate Families' step above."
        echo ""
        echo "ğŸ“ ARTIFACTS:"
        echo "   â€¢ generation_metadata.json - Generation statistics and metadata"
        echo "   â€¢ generation_output.txt - Complete console output with family details"
        echo ""
        echo "============================================================"
        echo "âœ… Enhanced family generation completed successfully!"
        echo "ğŸ”— Real database integration with OEWS wage data"
        echo "ğŸ“Š State-specific employment and education distributions" 
        echo "ğŸ’¼ Probability-based occupation selection"
        echo "============================================================"
    
    - name: Upload Generation Results
      uses: actions/upload-artifact@v4
      with:
        name: enhanced-family-generation-results
        path: |
          generation_metadata.json
          generation_output.txt
        retention-days: 30
    
    - name: Create Download Instructions
      run: |
        echo ""
        echo "ğŸ“ DOWNLOAD INSTRUCTIONS:"
        echo "   1. Go to the Actions tab in your repository"
        echo "   2. Click on this workflow run"
        echo "   3. Download the 'enhanced-family-generation-results' artifact"
        echo "   4. Extract the ZIP file to access:"
        echo "      â€¢ generation_metadata.json (statistics and metadata)"
        echo "      â€¢ generation_output.txt (complete family details)"
        echo ""
        echo "ğŸ’¾ Files will be available for 30 days"
